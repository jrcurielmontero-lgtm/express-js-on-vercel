import fetch from "node-fetch";

/**
 * Env√≠a un correo con la propuesta comercial al gestor.
 * @param {Object} params
 * @param {Object} params.attrs - Atributos del contacto (nombre, email, etc.)
 * @param {string} params.propuesta - Contenido de la propuesta generada
 */
export async function sendProposalEmail({ attrs, propuesta }) {
  if (!process.env.BREVO_API_KEY) {
    throw new Error("Falta BREVO_API_KEY en variables de entorno");
  }

  const nombreCliente = attrs.NOMBRE || "Cliente";
  const emailCliente = attrs.EMAIL || "sin_email@psicoboost.es";

  // URLs para las acciones del correo
  const baseUrl =
    process.env.BASE_URL ||
    "https://express-js-on-vercel.vercel.app";

  const urlAceptar = `https://calendly.com/psicoboost/asesoria?email=${encodeURIComponent(
    emailCliente
  )}`;
  const urlModificar = `${baseUrl}/api/EditarPropuesta?email=${encodeURIComponent(
    emailCliente
  )}`;

  // ‚úâÔ∏è Contenido HTML del correo
  const htmlContent = `
  <div style="font-family:Arial, sans-serif; color:#333; padding:20px; background:#f7f7f7; border-radius:8px;">
    <h2 style="color:#2B2D42;">Propuesta Comercial Psicoboost</h2>
    <p>Hola, <strong>gestor@psicoboost.es</strong>,</p>
    <p>Se ha generado una nueva propuesta para <strong>${nombreCliente}</strong>.</p>

    <div style="background:#fff; border:1px solid #ddd; padding:15px; border-radius:6px; margin-top:15px;">
      <pre style="white-space:pre-wrap; font-family:inherit;">${propuesta}</pre>
    </div>

    <div style="margin-top:25px; text-align:center;">
      <a href="${urlAceptar}" 
         style="background:#00b894; color:#fff; padding:12px 20px; text-decoration:none; border-radius:6px; font-weight:bold; margin-right:10px;">
        ‚úÖ Aceptar propuesta
      </a>

      <a href="${urlModificar}"
         style="background:#0984e3; color:#fff; padding:12px 20px; text-decoration:none; border-radius:6px; font-weight:bold;">
        ‚úèÔ∏è Modificar propuesta
      </a>
    </div>

    <p style="margin-top:30px; font-size:0.9em; color:#666;">
      Si no has solicitado esta propuesta, simplemente ignora este correo.
    </p>
  </div>
  `;

  const bodyEmail = {
    sender: { name: "Psicoboost", email: "gestor@psicoboost.es" },
    to: [{ email: "gestor@psicoboost.es" }],
    subject: `Propuesta Comercial - ${nombreCliente}`,
    htmlContent,
    textContent: propuesta,
  };

  console.log("üì® Enviando correo con Brevo a gestor@psicoboost.es...");

  const response = await fetch("https://api.brevo.com/v3/smtp/email", {
    method: "POST",
    headers: {
      accept: "application/json",
      "content-type": "application/json",
      "api-key": process.env.BREVO_API_KEY,
    },
    body: JSON.stringify(bodyEmail),
  });

  const data = await response.json();

  if (!response.ok) {
    console.error("‚ùå Error Brevo:", data);
    throw new Error(`Fallo al enviar correo: ${response.status}`);
  }

  return data;
}
